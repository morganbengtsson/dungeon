<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Dungeon on the fly</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="dungeon-on-the-fly">
<h1 class="title">Dungeon on the fly</h1>

<div class="section" id="a-project-in-the-course-procedural-methods-for-images-tnm022">
<h1>A project in the course Procedural methods for images, TNM022</h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Date:</th><td class="field-body">2016-12-13</td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Morgan Bengtsson</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:benmo417&#64;student.liu.se">benmo417&#64;student.liu.se</a>, <a class="reference external" href="mailto:bengtsson.morgan&#64;gmail.com">bengtsson.morgan&#64;gmail.com</a></td>
</tr>
<tr class="field"><th class="field-name">Verson:</th><td class="field-body">1.0</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body">Methods for procedural modeling are analysed. Mainly by using procedurally adjustable building blocks. Which resulted in an application that generates a complete and versatile dungeon.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="introduction">
<h1>Introduction</h1>
<p>This is a report for the final project in the course Procedural methods for images, TNM022 at Link√∂ping university.</p>
<p>Procedural methods for generating content for games is an attractive subject. Done right it can help to give the appearance of very big game world, without to much work regarding modeling and texturing. There are different routes to take when doing things procedurally. Either everything is fully procedural. Within the realm of 3D graphics meaning that, from each vertex in the models to every pixel in the textures are generated from mathematical functions. Another option is to combine procedural methods with manually made building blocks. This is the approach taken in this work, where predefined components are used with adjustable parameters to affect their appearance. Procedural methods can then be used to adjust those parameters. Furthermore also to choose what components are created, where they are placed, how many and so forth. This approach is often called shape algebra or procedural modeling. In this work these ideas are used to generate a dungeon, inspired from old games such as <a class="reference internal" href="#daggerfall">Daggerfall</a>.</p>
<div class="figure align-center">
<img alt="daggerfall.jpg" id="daggerfall" src="daggerfall.jpg" style="width: 70%;" />
<p class="caption">A dungeon from the old game Daggerfall.</p>
</div>
</div>
<div class="section" id="noise">
<h1>Noise</h1>
<p>The mathematical functions used for generating values are arbitrary. Though in this work mainly noise functions are used. An important property of them is that they are deterministic, meaning that the same input values will always generate the same output. Hence with the same input the exact same dungeon will be generated again in the end. This is important for games, since if the player comes back to a location, the same geometry should be present. Noise is also artistically pleasant for creating sense of randomness, while the predefined components gives a sense of structure. The main noise functions used throughout the implementation are described below:</p>
<p><a class="reference internal" href="#simplex-range">simplex_range</a> is a function that generates deterministic random values within a defined range. Three dimensional inputs are most often used, though others types are supported. The function is available in an integer and a float variant.</p>
<pre class="code c++ literal-block" id="simplex-range">
     <span class="keyword">template</span><span class="operator">&lt;</span><span class="keyword">class</span> <span class="name class">T</span><span class="operator">&gt;</span>
     <span class="keyword type">int</span> <span class="name">simplex_range</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">T</span> <span class="operator">&amp;</span><span class="name">seed</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">int</span> <span class="name">min</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">int</span> <span class="name">max</span><span class="punctuation">)</span> <span class="punctuation">{</span>
       <span class="comment single">// Noise value in range -1.0f, 1.0f.
</span>       <span class="keyword">auto</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">glm</span><span class="operator">::</span><span class="name">simplex</span><span class="punctuation">(</span><span class="name">seed</span><span class="punctuation">);</span>

       <span class="comment single">// Scale it to the min , max range.
</span>       <span class="keyword">auto</span> <span class="name">n</span> <span class="operator">=</span> <span class="punctuation">(((</span><span class="name">s</span> <span class="operator">+</span> <span class="literal number float">1.0f</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">max</span> <span class="operator">-</span> <span class="name">min</span><span class="punctuation">))</span> <span class="operator">/</span> <span class="literal number float">2.0f</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">min</span><span class="punctuation">;</span>
       <span class="keyword">return</span> <span class="name function">int</span><span class="punctuation">(</span><span class="name">n</span><span class="punctuation">);</span>
     <span class="punctuation">}</span>

     <span class="keyword">template</span><span class="operator">&lt;</span><span class="keyword">class</span> <span class="name class">T</span><span class="operator">&gt;</span>
     <span class="keyword type">float</span> <span class="name">simplex_range</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">T</span> <span class="operator">&amp;</span><span class="name">seed</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">float</span> <span class="name">min</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">float</span> <span class="name">max</span><span class="punctuation">){</span>
       <span class="comment single">// Noise value in range -1.0f, 1.0f.
</span>       <span class="keyword">auto</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">glm</span><span class="operator">::</span><span class="name">simplex</span><span class="punctuation">(</span><span class="name">seed</span><span class="punctuation">);</span>

       <span class="comment single">// Scale it to the min , max range.
</span>       <span class="keyword">auto</span> <span class="name">n</span> <span class="operator">=</span> <span class="punctuation">(((</span><span class="name">s</span> <span class="operator">+</span> <span class="literal number float">1.0f</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">max</span> <span class="operator">-</span> <span class="name">min</span><span class="punctuation">))</span> <span class="operator">/</span> <span class="literal number float">2.0f</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">min</span><span class="punctuation">;</span>
       <span class="keyword">return</span> <span class="name">n</span><span class="punctuation">;</span>
     <span class="punctuation">}</span>
</pre>
<p><a class="reference internal" href="#simplex-bool">simplex_bool</a> is a convenience method that either gives true or false depending on the input.</p>
<pre class="code c++ literal-block" id="simplex-bool">
<span class="keyword">template</span><span class="operator">&lt;</span><span class="keyword">class</span> <span class="name class">T</span><span class="operator">&gt;</span>
<span class="keyword type">bool</span> <span class="name">simplex_bool</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">T</span> <span class="operator">&amp;</span><span class="name">seed</span><span class="punctuation">)</span> <span class="punctuation">{</span>
   <span class="keyword">return</span> <span class="name">glm</span><span class="operator">::</span><span class="name">simplex</span><span class="punctuation">(</span><span class="name">seed</span><span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="literal number float">0.0f</span> <span class="operator">?</span> <span class="name builtin">true</span> <span class="operator">:</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="components">
<h1>Components</h1>
<p>There are two types of components defined to generate the dungeon: doors and entities.</p>
<div class="section" id="door">
<h2>Door</h2>
<p>Doors are small objects that define the connection between two entities. A door consist of a transform matrix, a pointer to the next entity and a <a class="reference internal" href="#door-model">model for rendering</a>. The door has two <em>states</em>; open and closed, which are set by the <a class="reference internal" href="#simplex-bool">simplex_bool</a> function. Input for that method is the door position.</p>
<div class="figure align-center">
<img alt="doors.png" id="door-model" src="doors.png" style="width: 70%;" />
<p class="caption">Door model with two states, open and closed.</p>
</div>
</div>
<div class="section" id="entity">
<h2>Entity</h2>
<p>The entity is a base component that the following components are based from. The
common denominator is that an entity can contain several doors that lead to new entities. An entity takes a transformation matrix that specifies where the entity should be generated. Each entity also contains a bounding box that is used for collision detection in the <a class="reference internal" href="#algorithm">algorithm</a>.</p>
<div class="section" id="corridor">
<h3>Corridor</h3>
<p>The corridor is a simple entity where the only adjustable parameter is its <em>length</em>. The length is defined with the <a class="reference internal" href="#simplex-range">simplex_range</a> function with position as input. At the end of the corridor an exit door is created. Only one <a class="reference internal" href="#corridor-model">model</a> is used for rendering and it is repeated until the desired length is reached.</p>
<div class="figure align-center">
<img alt="corridor.png" id="corridor-model" src="corridor.png" style="width: 70%;" />
<p class="caption">The corridor model.</p>
</div>
</div>
<div class="section" id="elevator">
<h3>Elevator</h3>
<p>The elevator is similar to the <a class="reference internal" href="#corridor">corridor</a> entity. With the difference that it extends in the vertical direction. Hence the <em>height</em> is the only adjustable parameter, populated by the <a class="reference internal" href="#simplex-range">simplex_range</a> function, with position as input. The model for this entity looks a bit different since it also has an animated cart, as shown in the <a class="reference internal" href="#elevator-model">image</a>. The model is repeated vertically until the desired height is reached.</p>
<div class="figure align-center">
<img alt="elevator.png" id="elevator-model" src="elevator.png" style="width: 70%;" />
<p class="caption">The elevator model, with the cart to the left.</p>
</div>
</div>
<div class="section" id="room">
<h3>Room</h3>
<p>The room is the most advanced and most configurable entity. Meaning that it can change much in appearance depending on what values are used to create it. The main values are its <em>size</em> in two dimensions and the room <em>type</em>. The <a class="reference internal" href="#simplex-range">simplex_range</a> function is used to initialize both, with room position as input. The input position is scaled a bit for the second <em>size</em> dimension, to not get square rooms.</p>
<p>The <em>type</em> value determines which set of models to use when creating the room. There are three sets, one with stone material one with metal material and one with wood material. There are several models that builds a room such as floor, edge models and corners. Some of the variations are shown in the <a class="reference internal" href="#room-edges">room edges</a> figure.</p>
<div class="figure align-center">
<img alt="room_edges.png" id="room-edges" src="room_edges.png" style="width: 70%;" />
<p class="caption">Different types of room edges.</p>
</div>
<p>When the room <em>type</em> is determined, the corresponding set of models are used to build the room. A two dimensional loop fills the room with models. Edge models for walls, special models for corners, entries, exits and floor models in the middle. What model variation that is used depends on the <a class="reference internal" href="#simplex-range">simplex_range</a> function with model position as input. As seen in the <a class="reference internal" href="#room-edges">room edges</a> figure, the stone material room has many variations. Walls are also varied slightly in height with the <a class="reference internal" href="#simplex-range">simplex_range</a> function.</p>
</div>
</div>
<div class="section" id="stairs">
<h2>Stairs</h2>
<p>Stairs are similar to the <a class="reference internal" href="#corridor">corridor</a> with its only adjustable parameter being its <em>length</em>. This variable is again populated by the <a class="reference internal" href="#simplex-range">simplex_range</a> method with position as input. The difference is that the stairs extends both vertically and horizontally. An exit door is added to the end of the model. There two versions of this entity, one that goes up and one that goes down, as shown in the <a class="reference internal" href="#stairs-models">stairs models</a> figure.</p>
<div class="figure align-center">
<img alt="stairs.png" id="stairs-models" src="stairs.png" style="width: 70%;" />
<p class="caption">Stairs up and down.</p>
</div>
</div>
</div>
<div class="section" id="items">
<h1>Items</h1>
<p>To further spice up the environment, some extra items are added to each <a class="reference internal" href="#room">room</a>. If they are placed on a floor model in the <a class="reference internal" href="#room">room</a> depends on the <a class="reference internal" href="#simplex-bool">simplex_bool</a> function and the model position. Which item is used is determined by <a class="reference internal" href="#simplex-range">simplex_range</a>, and the same position. The <a class="reference internal" href="#item-models">item models</a> are shown below:</p>
<div class="figure align-center">
<img alt="items.png" id="item-models" src="items.png" style="width: 70%;" />
<p class="caption">A table, a package and a tree.</p>
</div>
</div>
<div class="section" id="algorithm">
<h1>Algorithm</h1>
<p>To generate a dungeon the first entity has to be created manually. Then a loop iterates through all the entities, a defined number of times. Each time the loop checks for doors in each entity that has an empty pointer to their next entity. If that is the case a new entity is created and linked to that pointer.</p>
<p>Before the entity is linked to the door. The entity bounding box is checked for collision with all other bounding boxes in the level. If a collision is detected, the entity is discarded and the door hence leads nowhere. The door state is marked as closed in this case.</p>
<p>What type of entity that is generated is decided by a method that takes the door position as input and uses the <a class="reference internal" href="#simplex-range">simplex_range</a> method to get an index value. The index value is used on a container filled with all types of entities described in previous sections. When each entity is created it takes the door transform as input for further processing.</p>
</div>
<div class="section" id="implementation">
<h1>Implementation</h1>
<p>The implementation is done in C++ with a couple of helper libraries. One is <a class="reference external" href="https://github.com/morganbengtsson/mos">Mos</a>, mainly used for defining models and meshes for rendering. Another important one is <a class="reference external" href="http://glm.g-truc.net/0.9.8/index.html">GLM</a>, which is used for all the maths. Especially the simplex noise method that is essential for the <a class="reference internal" href="#algorithm">algorithm</a> and the procedural nature of all the entities. All models are made with <a class="reference external" href="https://www.blender.org/">Blender</a>.</p>
<p>The level is generated in its own thread at start up, to show how the dungeon generates and not to stall the rendering.</p>
<p>The code itself is available at <a class="reference external" href="https://github.com/morganbengtsson/dungeon">https://github.com/morganbengtsson/dungeon</a> and can be downloaded with the following git command:</p>
<pre class="code bash literal-block">
git clone --recursive https://github.com/morganbengtsson/dungeon.git
</pre>
<div class="section" id="build">
<h2>Build</h2>
<p>The application uses <a class="reference external" href="https://cmake.org/">CMake</a> as the build system. To build, create a directory named <em>build</em> in the downloaded source  directory. From the <em>build</em> directory run the following command:</p>
<pre class="code bash literal-block">
cmake ..
</pre>
<p>This should generate appropriate Makefiles for the Linux platform, or a Visual Studio project on the Windows platform.</p>
</div>
</div>
<div class="section" id="results-and-discussion">
<h1>Results and discussion</h1>
<p>A <a class="reference external" href="https://www.youtube.com/watch?v=-ZhnmNAsNJo">video</a> of the resulting application is available along with a <a class="reference internal" href="#screenshot">screenshot</a> below:</p>
<div class="figure align-center">
<a class="reference external image-reference" href="screenshot.png"><img alt="screenshot.png" id="screenshot" src="screenshot.png" style="width: 80%;" /></a>
<p class="caption">The resulting dungeon after six iterations.</p>
</div>
<p>The results for generating a dungeon procedurally this way are quite positive. With only a few basic models it is possible to generate a quite versatile dungeon. Many parameters are tweak-able, to quickly get a desired result. In contrast to manual modeling, which would take much longer. Also the numerical representation of a whole dungeon is very compact, only the first entity and a position.</p>
<p>Improvements that could be done are optimizations to the rendering. Even more variations in the different entities. The <a class="reference internal" href="#room">room</a> could be customized even further for example. With more floors, different shapes and materials. Procedural methods could have been used even further, to place or randomize vertex positions in the models. That would be at the cost of performance though.</p>
</div>
</div>
</body>
</html>
